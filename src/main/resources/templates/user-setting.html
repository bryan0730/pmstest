<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Title</title>
    <script th:src="@{/webjars/jquery/3.6.1/jquery.js}"></script>
</head>
<body>
  <table>
    <thead>
    <tr>
      <th>번호</th>
      <th>아이디</th>
      <th>이름</th>
      <th>휴대폰</th>
      <th>조직</th>
      <th>직급</th>
      <th>체크</th>
    </tr>
    </thead>
      <tbody>
      <tr th:each="user, stat : ${userList}">
        <input type="hidden" name="userId" th:value="${user.id}">
        <td th:text="|${stat.count}|"></td>
        <td th:text="${user.userId}"></td>
        <td th:text="${user.userName}"></td>
        <td th:text="${user.userPhoneNumber}"></td>
        <td th:text="${user.organizationName}"></td>
        <td th:text="${user.userRank}"></td>
        <td>
          <input type="checkbox" name="delYN" th:value="${user.userDeleteYN}">
        </td>
      </tr>
      </tbody>
      <button name="delBtn" id="delBtn">del</button>

  </table>
  <button onclick="location.href='/admin/user/join'">save popup</button>
</body>
</html>
<style>
  table {
    width: 100%;
    border: 1px solid #444444;
  }
  th, td {
    border: 1px solid #444444;
  }
</style>
<script>
  $("#delBtn").click(function(){
    if(!confirm("삭제하시겠습니까?")) return;

    let tdArr = [];
    const checkbox = $("input[name=delYN]:checked");

    const token = $("meta[name='_csrf']").attr("content");
    const header = $("meta[name='_csrf_header']").attr("content");

    checkbox.each(function(i) {
      let tr = checkbox.parent().parent().eq(i);
      let td = tr.children();

      let val = td.eq(0).val();
      let jsonObject = {"id": val};

      tdArr.push(jsonObject);
    });
    const jsonString = JSON.stringify(tdArr);

    $.ajax({
      url: "/admin/user/del",
      type: "POST",
      data: jsonString,
      beforeSend : function(xhr)
      {
        xhr.setRequestHeader(header, token);
      },
      dataType: "text",
      contentType:"application/json",
      success: function(data){
        alert(data);
        window.location.replace("/admin/user");
      },
      error: function(xhr, status, error){
        alert(xhr.responseText + error);
      }
    });
  });
</script>